# å®Œæ•´çš„ Vercel + Supabase æ•°æ®åº“è®¾ç½®æ–¹æ¡ˆ

> è¿™æ˜¯ä»é›¶å¼€å§‹çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬åœ¨ Vercel ä¸Šåˆ›å»º Storage å…³è”æ•°æ®åº“ï¼Œä»¥åŠæ‰€æœ‰å¿…è¦çš„æ•°æ®åº“ä¿®å¤æ­¥éª¤ã€‚

## æ–¹æ¡ˆé€‰æ‹©

ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

### æ–¹æ¡ˆ Aï¼šç»§ç»­ä½¿ç”¨ Supabaseï¼ˆæ¨è - å› ä¸ºä½ å·²ç»åœ¨ç”¨ï¼‰
- ä¼˜ç‚¹ï¼šä¸€ä¸ªæ•°æ®åº“ï¼Œæœ¬åœ°å’Œçº¿ä¸Šå…±äº«
- ç¼ºç‚¹ï¼šéœ€è¦æ‰‹åŠ¨åœ¨ Supabase ä¸Šæ‰§è¡Œ SQL

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Vercel PostgreSQL Storageï¼ˆå®Œå…¨æ‰˜ç®¡ï¼‰
- ä¼˜ç‚¹ï¼šVercel åŸç”Ÿé›†æˆï¼Œæ— éœ€é¢å¤–é…ç½®
- ç¼ºç‚¹ï¼šéœ€è¦è¿ç§»æ•°æ®ï¼Œæ”¹ DATABASE_URL

**æˆ‘æ¨èæ–¹æ¡ˆ A**ï¼Œå› ä¸ºä½ å·²ç»é…ç½®å¥½äº†ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´æ­¥éª¤ï¼š

---

## æ–¹æ¡ˆ Aï¼šä½¿ç”¨ç°æœ‰ Supabase æ•°æ®åº“ï¼ˆæ¨èï¼‰

### ç¬¬ 1 æ­¥ï¼šæ£€æŸ¥å½“å‰ Supabase æ•°æ®åº“

1. æ‰“å¼€ [Supabase Dashboard](https://app.supabase.com)
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. å·¦ä¾§èœå• â†’ **SQL Editor**
4. æ‰§è¡ŒæŸ¥è¯¢ï¼š
   ```sql
   SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
   ```
5. æŸ¥çœ‹æ˜¯å¦æœ‰ `posts` å’Œ `donations` è¡¨

### ç¬¬ 2 æ­¥ï¼šå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¨

åœ¨ SQL Editor ä¸­ä¾æ¬¡æ‰§è¡Œï¼š

#### åˆ›å»º posts è¡¨
```sql
CREATE TABLE "posts" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"title" text NOT NULL,
	"author" text NOT NULL,
	"description" text,
	"tags" json DEFAULT '[]'::json NOT NULL,
	"category" text,
	"img" text,
	"github" text,
	"reading_time_minutes" integer,
	"published_at" timestamp with time zone DEFAULT now() NOT NULL,
	"updated_at" timestamp with time zone DEFAULT now() NOT NULL
);
```

#### åˆ›å»º donations è¡¨
```sql
CREATE TABLE "donations" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
	"post_id" uuid NOT NULL,
	"tx_hash" text NOT NULL,
	"donor" text,
	"amount_wei" text NOT NULL,
	"created_at" timestamp with time zone DEFAULT now() NOT NULL
);
```

### ç¬¬ 3 æ­¥ï¼šä¿®å¤ tags åˆ—ç±»å‹ï¼ˆå¦‚æœè¡¨å·²å­˜åœ¨ä½† tags æ˜¯ text arrayï¼‰

å¦‚æœä½ å·²æœ‰ posts è¡¨ä½† tags åˆ—æ˜¯ `text[]` ç±»å‹ï¼Œæ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
BEGIN;

ALTER TABLE "posts" ADD COLUMN "tags_new" json DEFAULT '[]'::json;

UPDATE "posts" 
SET "tags_new" = CASE 
  WHEN "tags" IS NULL THEN '[]'::json
  WHEN "tags" = '{}'::text[] THEN '[]'::json
  ELSE to_json("tags")
END;

ALTER TABLE "posts" DROP COLUMN "tags";

ALTER TABLE "posts" RENAME COLUMN "tags_new" TO "tags";

ALTER TABLE "posts" ALTER COLUMN "tags" SET NOT NULL;

COMMIT;
```

### ç¬¬ 4 æ­¥ï¼šéªŒè¯ä¿®å¤æˆåŠŸ

æ‰§è¡ŒæŸ¥è¯¢éªŒè¯ï¼š
```sql
-- æ£€æŸ¥ posts è¡¨çš„ tags åˆ—ç±»å‹
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'posts' AND column_name = 'tags';
-- åº”è¯¥è¿”å›ï¼šcolumn_name='tags', data_type='json'

-- æ£€æŸ¥è¡¨ä¸­çš„æ•°æ®
SELECT COUNT(*) FROM "posts";
```

### ç¬¬ 5 æ­¥ï¼šæµ‹è¯•åº”ç”¨

1. æœ¬åœ°ï¼š`npm run dev`ï¼Œæµ‹è¯•æ–°å¢æ–‡ç« åŠŸèƒ½
2. Vercelï¼šé‡æ–°éƒ¨ç½²æˆ– push ä»£ç ï¼Œæµ‹è¯•æ–°å¢æ–‡ç« åŠŸèƒ½

---

## æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Vercel PostgreSQL Storageï¼ˆå¦‚æœæƒ³å®Œå…¨æ‰˜ç®¡ï¼‰

### ç¬¬ 1 æ­¥ï¼šåœ¨ Vercel åˆ›å»º PostgreSQL Storage

1. æ‰“å¼€ [Vercel Dashboard](https://vercel.com)
2. è¿›å…¥ä½ çš„é¡¹ç›®
3. ç‚¹å‡» **Storage** æ ‡ç­¾
4. ç‚¹å‡» **Create New** â†’ **Postgres**
5. é€‰æ‹©åœ°åŒºï¼Œç‚¹å‡» **Create**
6. ç­‰å¾…åˆ›å»ºå®Œæˆï¼Œå¤åˆ¶è¿æ¥å­—ç¬¦ä¸²

### ç¬¬ 2 æ­¥ï¼šæ›´æ–°æœ¬åœ° .env æ–‡ä»¶

```bash
# .env.localï¼ˆæœ¬åœ°å¼€å‘ç”¨æ–°çš„ Vercel è¿æ¥ï¼‰
DATABASE_URL=postgresql://[user]:[password]@[host]:[port]/[database]?sslmode=require
```

æ›¿æ¢ä¸ºä» Vercel Storage å¤åˆ¶çš„è¿æ¥å­—ç¬¦ä¸²ã€‚

### ç¬¬ 3 æ­¥ï¼šåœ¨ Vercel SQL Editor åˆ›å»ºè¡¨

1. Vercel Dashboard â†’ Storage â†’ ä½ çš„ PostgreSQL æ•°æ®åº“ â†’ **SQL Editor**
2. æ‰§è¡Œä¸¤ä¸ªå»ºè¡¨ SQLï¼ˆåŒä¸Šé¢æ–¹æ¡ˆ A çš„ç¬¬ 2 æ­¥ï¼‰

### ç¬¬ 4 æ­¥ï¼šæ›´æ–° .env.production

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env.productionï¼ˆæˆ–åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼‰
DATABASE_URL=postgresql://[user]:[password]@[host]:[port]/[database]?sslmode=require
```

### ç¬¬ 5 æ­¥ï¼šæ¨é€ä»£ç å¹¶é‡æ–°éƒ¨ç½²

```bash
git add .
git commit -m "Switch to Vercel PostgreSQL"
git push origin main
```

---

## å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] èƒ½å¦è¿æ¥åˆ°æ•°æ®åº“ï¼ˆæ£€æŸ¥ `.env` ä¸­çš„ `DATABASE_URL`ï¼‰
- [ ] `posts` è¡¨æ˜¯å¦å­˜åœ¨
- [ ] `donations` è¡¨æ˜¯å¦å­˜åœ¨
- [ ] `posts.tags` åˆ—ç±»å‹æ˜¯å¦ä¸º `json`ï¼ˆä¸æ˜¯ `text[]`ï¼‰
- [ ] æœ¬åœ° `npm run dev` èƒ½å¦è®¿é—®æ–°å¢æ–‡ç« é¡µé¢
- [ ] æœ¬åœ°æ–°å¢æ–‡ç« æ˜¯å¦æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“
- [ ] Vercel æ˜¯å¦èƒ½çœ‹åˆ°æ–°å¢çš„æ–‡ç« æ•°æ®

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæœ¬åœ°èƒ½è¿è¡Œä½† Vercel æŠ¥é”™ï¼Ÿ
A: é€šå¸¸æ˜¯å› ä¸ºï¼š
1. è¡¨ç»“æ„ä¸åŒ¹é…ï¼ˆtags ç±»å‹ä¸åŒï¼‰
2. ç¯å¢ƒå˜é‡æœªè®¾ç½®
3. Drizzle ORM åœ¨ä¸åŒç¯å¢ƒçš„åºåˆ—åŒ–å·®å¼‚

### Q: å¦‚ä½•æŸ¥çœ‹ Supabase/Vercel ä¸­çš„å®é™…æ•°æ®ï¼Ÿ
A: 
- **Supabase**ï¼šDashboard â†’ Table Editor â†’ é€‰æ‹©è¡¨ â†’ æŸ¥çœ‹è¡Œ
- **Vercel**ï¼šStorage â†’ PostgreSQL â†’ SQL Editor â†’ æ‰§è¡Œ `SELECT * FROM posts;`

### Q: æ€ä¹ˆåˆ é™¤é”™è¯¯çš„è¡¨é‡æ¥ï¼Ÿ
A: åœ¨ SQL Editor æ‰§è¡Œï¼š
```sql
DROP TABLE IF EXISTS "posts" CASCADE;
DROP TABLE IF EXISTS "donations" CASCADE;
```
ç„¶åé‡æ–°æ‰§è¡Œå»ºè¡¨ SQLã€‚

### Q: tags åˆ—ä¸ºä»€ä¹ˆè¦ç”¨ json è€Œä¸æ˜¯ text[]ï¼Ÿ
A: å› ä¸º Drizzle ORM ç”¨ `json()` å®šä¹‰ï¼Œåœ¨ä¸åŒæ•°æ®åº“é©±åŠ¨ä¸‹çš„åºåˆ—åŒ–è¡Œä¸ºæ›´ä¸€è‡´ã€‚

---

## æ¨èæµç¨‹ï¼ˆå¿«é€Ÿç‰ˆï¼‰

1. **æ£€æŸ¥ç°çŠ¶**
   ```sql
   SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
   ```

2. **å¦‚æœæ²¡è¡¨ï¼Œåˆ›å»º**
   - æ‰§è¡Œä¸Šé¢çš„ä¸¤ä¸ª CREATE TABLE SQL

3. **å¦‚æœæœ‰è¡¨ä½† tags é”™è¯¯ï¼Œä¿®å¤**
   - æ‰§è¡Œä¸Šé¢çš„ ALTER TABLE SQL

4. **æµ‹è¯•**
   - æœ¬åœ°ï¼š`npm run dev` â†’ æ–°å¢æ–‡ç« 
   - çº¿ä¸Šï¼šVercel â†’ æ–°å¢æ–‡ç« 

å®Œæˆï¼ğŸ‰
